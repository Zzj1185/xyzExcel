<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åæ ‡æµ‹é‡æ•°æ®ç”Ÿæˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title span {
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        /* Excelé…ç½® */
        .excel-config {
            background: #f0f4ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #d0d8ff;
        }

        .config-row {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .config-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-item label {
            font-weight: 500;
            color: #444;
            white-space: nowrap;
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            background: white;
            border: 2px solid #ddd;
            transition: all 0.2s;
        }

        .radio-label:hover {
            border-color: #667eea;
        }

        .radio-label input[type="radio"] {
            cursor: pointer;
        }

        .radio-label input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 600;
        }

        .radio-label:has(input:checked) {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .filename-input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 300px;
            transition: all 0.2s;
        }

        .filename-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #eef0ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e0e4ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        #file-input {
            display: none;
        }

        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            display: none;
            margin-bottom: 20px;
        }

        .image-preview.show {
            display: block;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .image-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* OCRç»“æœ */
        .ocr-result {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .ocr-result.show {
            display: block;
        }

        .ocr-result pre {
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            color: #666;
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .format-hint {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }

        .format-hint code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .tolerance-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        input[type="number"] {
            width: 100px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .points-table th,
        .points-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .points-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .points-table tr:hover {
            background: #f8f9fa;
        }

        .points-table input {
            width: 100px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-family: monospace;
        }

        .csv-output {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            background: #f8f9fa;
            resize: vertical;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 14px;
            margin-left: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .edit-table-section {
            display: none;
        }

        .edit-table-section.show {
            display: block;
        }

        .action-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-add {
            background: #28a745;
            color: white;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .stats {
                flex-direction: column;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ä¸‰åæ ‡æµ‹é‡æ•°æ®ç”Ÿæˆå·¥å…·</h1>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="card">
            <div class="card-title">
                <span>1</span>
                è¾“å…¥åæ ‡æ•°æ®
            </div>

            <!-- Excelé…ç½® -->
            <div class="excel-config">
                <div class="config-row">
                    <div class="config-item">
                        <label>å·¥ä½œè¡¨ï¼š</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="sheet_name" value="å‰æ¨¡ä»" checked>
                                <span>å‰æ¨¡ä»</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="sheet_name" value="åæ¨¡ä»">
                                <span>åæ¨¡ä»</span>
                            </label>
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Excelæ–‡ä»¶åï¼š</label>
                        <input type="text" id="excel-filename" class="filename-input"
                               placeholder="ä¾‹å¦‚: P25-XXX-é›¶ä»¶åç§°-ä¸‰åæ ‡æŠ¥å‘Š">
                    </div>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µåˆ‡æ¢å·²ç§»é™¤ -->

            <!-- å›¾ç‰‡ä¸Šä¼  -->
            <div id="tab-upload" class="tab-content active" style="display: block;">
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="upload-hint">å›¾ç‰‡å°†åµŒå…¥ExcelæŠ¥å‘Šï¼ŒåŒæ—¶å°è¯•OCRè¯†åˆ«åæ ‡</div>
                </div>
                <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(event)">

                <div class="image-preview" id="image-preview">
                    <img id="preview-img" src="" alt="é¢„è§ˆ">
                    <div class="image-info">
                        <span id="file-name"></span>
                        <button class="btn btn-small" onclick="clearImage()">ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡</button>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨å°è¯•è¯†åˆ«...</div>
                </div>

                <!-- æ•°æ®è¾“å…¥æ¨¡å¼é€‰æ‹©ï¼ˆå›¾ç‰‡ä¸Šä¼ åæ˜¾ç¤ºï¼‰ -->
                <div id="data-mode-section" class="edit-table-section">
                    <div style="margin-bottom: 15px; padding: 15px; background: #f0f4ff; border-radius: 10px;">
                        <label style="margin-bottom: 10px; display: block;">æ•°æ®æ¥æºï¼š</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="data_mode" value="ocr" checked onchange="switchDataMode('ocr')">
                                <span>ä½¿ç”¨OCRè¯†åˆ«ç»“æœ</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="data_mode" value="paste" onchange="switchDataMode('paste')">
                                <span>ç²˜è´´å®Œæ•´æµ‹é‡æ•°æ®</span>
                            </label>
                        </div>
                    </div>

                    <!-- OCRç»“æœè¡¨æ ¼ -->
                    <div id="ocr-result-section">
                        <table class="points-table" id="edit-table">
                            <thead>
                                <tr>
                                    <th>ç¼–å·</th>
                                    <th>X</th>
                                    <th>Y</th>
                                    <th>Z</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="edit-table-body">
                            </tbody>
                        </table>
                    </div>

                    <!-- ç²˜è´´å®Œæ•´æ•°æ®åŒºåŸŸ -->
                    <div id="paste-data-section" style="display: none;">
                        <div class="input-group">
                            <label>ç²˜è´´å®Œæ•´æµ‹é‡æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰ï¼š</label>
                            <textarea id="paste-csv-input" placeholder="ç²˜è´´åŒ…å«æµ‹é‡ç‚¹ã€è½´ã€å…¬å·®ã€æ ‡ç§°å€¼ã€å®æµ‹å€¼ã€åå·®ã€çŠ¶æ€ç­‰å®Œæ•´æ•°æ®çš„CSV...

æ ¼å¼ç¤ºä¾‹ï¼š
æµ‹é‡ç‚¹,è½´,TOL,TOL,NomiNal,Measured,Dev/Mean,Error/OK
æµ‹é‡ç‚¹1,X,-0.03,0.03,-172.160,-172.152,0.008,OK
,Y,-0.03,0.03,-242.019,-242.025,-0.006,OK
,Z,-0.03,0.03,14.281,14.288,0.007,OK
..."></textarea>
                        </div>
                        <div class="format-hint">
                            <strong>æ ¼å¼è¯´æ˜ï¼š</strong>åŒ…å«å®æµ‹å€¼å’Œåå·®çš„å®Œæ•´æ•°æ®ï¼Œç³»ç»Ÿå°†ç›´æ¥ä½¿ç”¨ï¼Œä¸å†ç”Ÿæˆéšæœºåå·®ã€‚
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="parsePastedCSV()">
                                ğŸ“¥ è§£æç²˜è´´çš„æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸå·²ç§»é™¤ -->

            <div class="tolerance-group">
                <label style="margin-bottom: 0;">å…¬å·®èŒƒå›´ (Â±)ï¼š</label>
                <input type="number" id="tolerance" value="0.03" step="0.01" min="0.001" max="1">
                <span>mm</span>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="generate-btn" onclick="showResultSection()">
                    âœ… ç¡®è®¤åæ ‡æ•°æ®
                </button>
                <button class="btn" style="background: #6c757d; color: white;" onclick="clearAll()">
                    ğŸ—‘ï¸ æ¸…ç©º
                </button>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error-alert" class="alert alert-error" style="display: none;"></div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div id="result-section" class="result-section">
            <div class="card">
                <div class="card-title">
                    <span>2</span>
                    <span id="result-title">è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘ï¼‰</span>
                    <div style="margin-left: auto; display: flex; gap: 20px; font-size: 15px; font-weight: normal; color: #555;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            æµ‹é‡ç‚¹æ•°: <strong id="points-count" style="color: #667eea; font-size: 1.2rem;">0</strong>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            æ•°æ®æ¡æ•°: <strong id="data-count" style="color: #667eea; font-size: 1.2rem;">0</strong>
                        </div>
                    </div>
                </div>

                <!-- å¯ç¼–è¾‘è¡¨æ ¼ -->
                <table class="points-table">
                    <thead>
                        <tr>
                            <th>ç¼–å·</th>
                            <th>X</th>
                            <th>Y</th>
                            <th>Z</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="points-table-body">
                    </tbody>
                </table>
                <button class="btn btn-add" onclick="addNewPoint()" style="margin-top: 10px;">â• æ·»åŠ æµ‹é‡ç‚¹</button>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>3</span>
                    ç”Ÿæˆæµ‹é‡æ•°æ®
                </div>

                <!-- OCRæ¨¡å¼æ‰æ˜¾ç¤ºç”ŸæˆæŒ‰é’® -->
                <div id="generate-btn-section" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="generateCSVData()" style="width: 100%;">
                        ğŸš€ ç”Ÿæˆæµ‹é‡æ•°æ®ï¼ˆç¡®è®¤ç¼–è¾‘åç‚¹å‡»ï¼‰
                    </button>
                </div>

                <textarea id="csv-output" class="csv-output" readonly placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæµ‹é‡æ•°æ®..."></textarea>

                <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="copyCSV()" style="background: #6c757d; color: white;">
                        ğŸ“‹ å¤åˆ¶CSV
                    </button>
                    <button class="btn btn-success" onclick="downloadCSV()">
                        ğŸ“¥ ä¸‹è½½CSVæ–‡ä»¶
                    </button>
                    <button class="btn btn-primary" onclick="downloadExcel()">
                        ğŸ“Š ä¸‹è½½ExcelæŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCSV = '';
        let currentPoints = [];
        let currentTab = 'upload';
        let currentInputMode = 'ocr'; // 'ocr' or 'paste'
        let pastedFullData = null; // å­˜å‚¨ç²˜è´´çš„å®Œæ•´æ•°æ®

        // å¤šå·¥ä½œè¡¨æ”¯æŒ
        let currentSheet = 'å‰æ¨¡ä»';
        const sheetsState = {
            'å‰æ¨¡ä»': { points: [], csv: '', imageSrc: null, imageName: '', fullData: null },
            'åæ¨¡ä»': { points: [], csv: '', imageSrc: null, imageName: '', fullData: null }
        };

        // åˆå§‹åŒ–å•é€‰æ¡†ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="sheet_name"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    switchSheet(e.target.value);
                });
            });
        });

        // åˆ‡æ¢æ•°æ®æ¥æºæ¨¡å¼
        function switchDataMode(mode) {
            currentInputMode = mode;
            if (mode === 'ocr') {
                document.getElementById('ocr-result-section').style.display = 'block';
                document.getElementById('paste-data-section').style.display = 'none';
            } else {
                document.getElementById('ocr-result-section').style.display = 'none';
                document.getElementById('paste-data-section').style.display = 'block';
            }
        }

        // è§£æç²˜è´´çš„å®Œæ•´CSVæ•°æ®
        function parsePastedCSV() {
            // æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ å›¾ç‰‡
            const previewImg = document.getElementById('preview-img');
            if (!previewImg.src || !previewImg.src.startsWith('data:')) {
                showError('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                return;
            }

            const csvText = document.getElementById('paste-csv-input').value.trim();
            if (!csvText) {
                showError('è¯·ç²˜è´´CSVæ•°æ®');
                return;
            }

            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) {
                showError('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
                return;
            }

            // è·³è¿‡æ ‡é¢˜è¡Œ
            const dataLines = lines.slice(1);
            const fullData = []; // å®Œæ•´æ•°æ®ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰
            const points = []; // åæ ‡ç‚¹ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            let currentPointId = 0;
            let currentPointData = { id: 0, x: 0, y: 0, z: 0 };

            for (const line of dataLines) {
                const cols = line.split(',');
                if (cols.length < 7) continue;

                const pointName = cols[0].trim();
                const axis = cols[1].trim().toUpperCase();
                const tolMin = parseFloat(cols[2]) || -0.03;
                const tolMax = parseFloat(cols[3]) || 0.03;
                const nominal = parseFloat(cols[4]) || 0;
                const measured = parseFloat(cols[5]) || 0;
                const deviation = parseFloat(cols[6]) || 0;
                const status = cols[7] ? cols[7].trim() : 'OK';

                // æå–æµ‹é‡ç‚¹ç¼–å·
                let pointId = currentPointId;
                if (pointName) {
                    const match = pointName.match(/(\d+)/);
                    if (match) {
                        pointId = parseInt(match[1]);
                        currentPointId = pointId;
                    }
                }

                fullData.push({
                    pointId,
                    pointName: pointName || '',
                    axis,
                    tolMin,
                    tolMax,
                    nominal,
                    measured,
                    deviation,
                    status
                });

                // æ„å»ºåæ ‡ç‚¹ç”¨äºæ˜¾ç¤º
                if (axis === 'X') {
                    currentPointData = { id: pointId, x: nominal, y: 0, z: 0 };
                } else if (axis === 'Y') {
                    currentPointData.y = nominal;
                } else if (axis === 'Z') {
                    currentPointData.z = nominal;
                    points.push({ ...currentPointData });
                }
            }

            if (points.length === 0) {
                showError('æœªèƒ½è§£æå‡ºæœ‰æ•ˆçš„æµ‹é‡ç‚¹æ•°æ®');
                return;
            }

            // ä¿å­˜å®Œæ•´æ•°æ®
            pastedFullData = fullData;
            currentPoints = points;
            sheetsState[currentSheet].fullData = fullData;
            sheetsState[currentSheet].points = points;

            // ç›´æ¥ç”ŸæˆCSVï¼ˆå› ä¸ºå·²ç»æœ‰å®Œæ•´æ•°æ®äº†ï¼‰
            generateCSVFromFullData();

            // æ›´æ–°ç•Œé¢æ˜¾ç¤ºï¼ˆç²˜è´´æ¨¡å¼ï¼‰
            document.getElementById('result-title').textContent = 'æµ‹é‡æ•°æ®ï¼ˆå·²å¯¼å…¥ï¼‰';
            document.getElementById('generate-btn-section').style.display = 'none';

            // ç›´æ¥è·³è½¬åˆ°ç»“æœåŒºåŸŸï¼ˆç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥åˆå¹¶ï¼‰
            updateResultView();
            document.getElementById('csv-output').value = currentCSV;
            document.getElementById('result-section').classList.add('show');
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });

            hideError();
            console.log(`è§£ææˆåŠŸï¼š${points.length} ä¸ªæµ‹é‡ç‚¹ï¼Œ${fullData.length} æ¡æ•°æ®`);
        }

        // ä»å®Œæ•´æ•°æ®ç”ŸæˆCSV
        function generateCSVFromFullData() {
            if (!pastedFullData || pastedFullData.length === 0) return;

            let csv = 'æµ‹é‡ç‚¹,è½´,TOL,TOL,NomiNal,Measured,Dev/Mean,Error/OK\n';
            for (const row of pastedFullData) {
                csv += `${row.pointName},${row.axis},${row.tolMin},${row.tolMax},${row.nominal.toFixed(3)},${row.measured.toFixed(3)},${row.deviation.toFixed(3)},${row.status}\n`;
            }
            currentCSV = csv.trim();
            sheetsState[currentSheet].csv = currentCSV;
        }

        function switchSheet(newSheet) {
            // ä¿å­˜å½“å‰çŠ¶æ€
            sheetsState[currentSheet].points = currentPoints;
            sheetsState[currentSheet].csv = currentCSV;

            const previewImg = document.getElementById('preview-img');
            const previewContainer = document.getElementById('image-preview');

            if (previewContainer.classList.contains('show') && previewImg.src && previewImg.src.startsWith('data:')) {
                sheetsState[currentSheet].imageSrc = previewImg.src;
                sheetsState[currentSheet].imageName = document.getElementById('file-name').textContent;
            } else {
                sheetsState[currentSheet].imageSrc = null;
                sheetsState[currentSheet].imageName = '';
            }

            // åˆ‡æ¢çŠ¶æ€
            currentSheet = newSheet;
            currentPoints = sheetsState[newSheet].points || [];
            currentCSV = sheetsState[newSheet].csv || '';

            // æ¢å¤UI
            if (sheetsState[newSheet].imageSrc) {
                document.getElementById('preview-img').src = sheetsState[newSheet].imageSrc;
                document.getElementById('file-name').textContent = sheetsState[newSheet].imageName;
                document.getElementById('image-preview').classList.add('show');
                document.getElementById('upload-area').style.display = 'none';
            } else {
                clearImageUI();
            }

            displayEditTable(currentPoints);
            updateResultView();
        }

        function clearImageUI() {
            document.getElementById('image-preview').classList.remove('show');
            document.getElementById('upload-area').style.display = 'block';
            document.getElementById('file-input').value = '';
        }

        function updateResultView() {
            if (currentPoints.length > 0) {
                 document.getElementById('points-count').textContent = currentPoints.length;
                 document.getElementById('data-count').textContent = currentPoints.length * 3;

                 const tbody = document.getElementById('points-table-body');
                 tbody.innerHTML = '';
                 currentPoints.forEach((point, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="number" value="${point.id}" style="width: 60px;" onchange="updateResultPoint(${index}, 'id', this.value)"></td>
                        <td><input type="text" value="${point.x.toFixed(3)}" style="width: 100px;" onchange="updateResultPoint(${index}, 'x', this.value)"></td>
                        <td><input type="text" value="${point.y.toFixed(3)}" style="width: 100px;" onchange="updateResultPoint(${index}, 'y', this.value)"></td>
                        <td><input type="text" value="${point.z.toFixed(3)}" style="width: 100px;" onchange="updateResultPoint(${index}, 'z', this.value)"></td>
                        <td><button class="btn btn-small btn-danger" onclick="deleteResultPoint(${index})">ğŸ—‘ï¸</button></td>
                    `;
                    tbody.appendChild(row);
                 });

                 document.getElementById('csv-output').value = currentCSV;
                 document.getElementById('result-section').classList.add('show');
            } else {
                document.getElementById('result-section').classList.remove('show');
            }
        }

        // æ›´æ–°ç»“æœä¸­çš„æµ‹é‡ç‚¹
        function updateResultPoint(index, field, value) {
            if (field === 'id') {
                currentPoints[index].id = parseInt(value) || 1;
            } else {
                currentPoints[index][field] = parseFloat(value) || 0;
            }
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('points-count').textContent = currentPoints.length;
            document.getElementById('data-count').textContent = currentPoints.length * 3;
        }

        // åˆ é™¤ç»“æœä¸­çš„æµ‹é‡ç‚¹
        function deleteResultPoint(index) {
            currentPoints.splice(index, 1);
            updateResultView();
            // CSVéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®é‡æ–°ç”Ÿæˆ
        }

        // æ·»åŠ æ–°æµ‹é‡ç‚¹
        function addNewPoint() {
            const newId = currentPoints.length > 0 ? Math.max(...currentPoints.map(p => p.id)) + 1 : 1;
            currentPoints.push({ id: newId, x: 0, y: 0, z: 0 });
            updateResultView();
        }

        // ç”ŸæˆCSVæ•°æ®ï¼ˆç”¨æˆ·ç‚¹å‡»æŒ‰é’®åè°ƒç”¨ï¼‰
        async function generateCSVData() {
            if (currentPoints.length === 0) {
                showError('æ²¡æœ‰åæ ‡æ•°æ®');
                return;
            }

            // å¦‚æœæ˜¯ç²˜è´´æ¨¡å¼ä¸”æœ‰å®Œæ•´æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨å·²æœ‰çš„CSV
            if (currentInputMode === 'paste' && pastedFullData && pastedFullData.length > 0) {
                generateCSVFromFullData();
                document.getElementById('csv-output').value = currentCSV;
                return;
            }

            // OCRæ¨¡å¼ï¼šè°ƒç”¨åç«¯ç”Ÿæˆéšæœºåå·®æ•°æ®
            const tolerance = parseFloat(document.getElementById('tolerance').value) || 0.03;
            try {
                const response = await fetch('/generate_from_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points: currentPoints, tolerance })
                });
                const result = await response.json();
                if (response.ok) {
                    currentCSV = result.csv;
                    document.getElementById('csv-output').value = currentCSV;
                } else {
                    showError(result.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // å¤„ç†æ–‡ä»¶
        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('image-preview').classList.add('show');
                document.getElementById('upload-area').style.display = 'none';
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ è¯†åˆ«
            await uploadImage(file);
        }

        // ä¸Šä¼ å›¾ç‰‡è¯†åˆ«
        async function uploadImage(file) {
            document.getElementById('loading').classList.add('show');
            hideError();

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                document.getElementById('loading').classList.remove('show');

                if (!response.ok) {
                    showError(result.error || 'è¯†åˆ«å¤±è´¥');
                    return;
                }

                // æ˜¾ç¤ºå¯ç¼–è¾‘è¡¨æ ¼
                currentPoints = result.points || [];
                displayEditTable(currentPoints);

                if (currentPoints.length === 0) {
                    showError('æœªèƒ½ä»å›¾ç‰‡ä¸­è¯†åˆ«åˆ°åæ ‡æ•°æ®ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹è¾“å…¥æ¡†æ‰‹åŠ¨æ·»åŠ ');
                } else {
                    // æç¤ºè¯†åˆ«æˆåŠŸ
                    console.log('OCRè¯†åˆ«æˆåŠŸï¼Œä½¿ç”¨: ' + result.ocr_provider);
                }

            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                showError('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå¯ç¼–è¾‘è¡¨æ ¼
        function displayEditTable(points) {
            const tbody = document.getElementById('edit-table-body');
            tbody.innerHTML = '';

            points.forEach((point, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="number" value="${point.id}" onchange="updatePoint(${index}, 'id', this.value)"></td>
                    <td><input type="text" value="${point.x.toFixed(3)}" onchange="updatePoint(${index}, 'x', this.value)"></td>
                    <td><input type="text" value="${point.y.toFixed(3)}" onchange="updatePoint(${index}, 'y', this.value)"></td>
                    <td><input type="text" value="${point.z.toFixed(3)}" onchange="updatePoint(${index}, 'z', this.value)"></td>
                    <td><button class="btn btn-small btn-danger" onclick="deletePoint(${index})">ğŸ—‘ï¸</button></td>
                `;
                tbody.appendChild(row);
            });

            // æ˜¾ç¤ºæ•°æ®æ¨¡å¼é€‰æ‹©åŒºåŸŸ
            document.getElementById('data-mode-section').classList.add('show');
        }

        // æ›´æ–°ç‚¹
        function updatePoint(index, field, value) {
            if (field === 'id') {
                currentPoints[index].id = parseInt(value);
            } else {
                currentPoints[index][field] = parseFloat(value);
            }
        }

        // åˆ é™¤ç‚¹
        function deletePoint(index) {
            currentPoints.splice(index, 1);
            displayEditTable(currentPoints);
        }

        // æ·»åŠ ç‚¹
        function addPoint() {
            const newId = currentPoints.length > 0 ? Math.max(...currentPoints.map(p => p.id)) + 1 : 1;
            currentPoints.push({ id: newId, x: 0, y: 0, z: 0 });
            displayEditTable(currentPoints);
        }

        // æ¸…é™¤å›¾ç‰‡
        function clearImage() {
            clearImageUI();

            // å°è¯•éšè—ocr-result, å¦‚æœä¸å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯
            const ocrResult = document.getElementById('ocr-result');
            if (ocrResult) ocrResult.classList.remove('show');

            // éšè—æ•°æ®æ¨¡å¼é€‰æ‹©åŒºåŸŸ
            document.getElementById('data-mode-section').classList.remove('show');
            currentPoints = [];
            pastedFullData = null;

            // æ¸…é™¤å½“å‰çŠ¶æ€
            sheetsState[currentSheet].imageSrc = null;
            sheetsState[currentSheet].imageName = '';
            sheetsState[currentSheet].points = [];
            sheetsState[currentSheet].fullData = null;
        }

        // æ˜¾ç¤ºç»“æœåŒºåŸŸï¼ˆç¡®è®¤åæ ‡æ•°æ®ï¼‰
        function showResultSection() {
            hideError();

            if (currentPoints.length === 0) {
                showError('æ²¡æœ‰åæ ‡æ•°æ®ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡è¿›è¡Œè¯†åˆ«æˆ–ç²˜è´´æ•°æ®');
                return;
            }

            // æ˜¾ç¤ºå¯ç¼–è¾‘çš„ç»“æœè¡¨æ ¼
            updateResultView();

            // å¦‚æœæ˜¯ç²˜è´´æ¨¡å¼ä¸”æœ‰å®Œæ•´æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤ºCSV
            if (currentInputMode === 'paste' && pastedFullData && pastedFullData.length > 0) {
                document.getElementById('result-title').textContent = 'æµ‹é‡æ•°æ®ï¼ˆå·²å¯¼å…¥ï¼‰';
                document.getElementById('generate-btn-section').style.display = 'none';
                document.getElementById('csv-output').value = currentCSV;
            } else {
                // OCRæ¨¡å¼ï¼šæ¢å¤æ­£å¸¸æ˜¾ç¤º
                document.getElementById('result-title').textContent = 'è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘ï¼‰';
                document.getElementById('generate-btn-section').style.display = 'block';
                // æ¸…ç©ºCSVï¼Œç­‰ç”¨æˆ·ç‚¹å‡»ç”ŸæˆæŒ‰é’®
                currentCSV = '';
                document.getElementById('csv-output').value = '';
            }

            document.getElementById('result-section').classList.add('show');
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        }

        // ç”Ÿæˆæ•°æ®ï¼ˆä¿ç•™å…¼å®¹ï¼‰
        async function generateData() {
            const tolerance = parseFloat(document.getElementById('tolerance').value) || 0.03;
            hideError();

            let points = currentPoints;

            if (points.length === 0) {
                showError('æ²¡æœ‰åæ ‡æ•°æ®ï¼Œè¯·ä¸Šä¼ å›¾ç‰‡è¿›è¡Œè¯†åˆ«');
                return;
            }

            // ä»ç‚¹ç”Ÿæˆ
            try {
                const response = await fetch('/generate_from_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points, tolerance })
                });

                const result = await response.json();
                if (!response.ok) {
                    showError(result.error || 'ç”Ÿæˆå¤±è´¥');
                    return;
                }

                displayResult(result);

            } catch (error) {
                showError('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        function displayResult(result) {
            // æ›´æ–°æ•°æ®ï¼ˆåªä¿å­˜è¯†åˆ«ç»“æœï¼Œä¸ç”ŸæˆCSVï¼‰
            currentPoints = result.points;
            currentCSV = ''; // æ¸…ç©ºCSVï¼Œç­‰ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆ

            // ä½¿ç”¨ç»Ÿä¸€çš„å¯ç¼–è¾‘è¡¨æ ¼æ¸²æŸ“
            updateResultView();

            // æ¸…ç©ºCSVæ˜¾ç¤ºåŒºåŸŸï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»ç”Ÿæˆ
            document.getElementById('csv-output').value = '';

            // æ»šåŠ¨åˆ°ç»“æœ
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCSV() {
            const csvOutput = document.getElementById('csv-output');
            csvOutput.select();
            document.execCommand('copy');

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ… å·²å¤åˆ¶';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        async function downloadCSV() {
            if (!currentCSV) {
                showError('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv: currentCSV })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showError(error.error || 'ä¸‹è½½å¤±è´¥');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æµ‹é‡æ•°æ®_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (error) {
                showError('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        async function downloadExcel() {
            // ä¿å­˜å½“å‰çŠ¶æ€
            sheetsState[currentSheet].points = currentPoints;
            sheetsState[currentSheet].fullData = pastedFullData;
            const previewImg = document.getElementById('preview-img');
            if (previewImg.src && previewImg.src.startsWith('data:')) {
                sheetsState[currentSheet].imageSrc = previewImg.src;
            }

            const filename = document.getElementById('excel-filename').value.trim();
            if (!filename) {
                showError('è¯·è¾“å…¥Excelæ–‡ä»¶å');
                document.getElementById('excel-filename').focus();
                return;
            }

            // æ„å»ºå¤šè¡¨æ•°æ®
            const sheetsData = [];
            ['å‰æ¨¡ä»', 'åæ¨¡ä»'].forEach(sheetName => {
                const state = sheetsState[sheetName];
                if (state.points && state.points.length > 0) {
                    const sheetData = {
                        sheet_name: sheetName,
                        points: state.points,
                        image_data: state.imageSrc
                    };
                    // å¦‚æœæœ‰å®Œæ•´æ•°æ®ï¼ˆç²˜è´´æ¨¡å¼ï¼‰ï¼Œæ·»åŠ full_data
                    if (state.fullData && state.fullData.length > 0) {
                        sheetData.full_data = state.fullData;
                    }
                    sheetsData.push(sheetData);
                }
            });

            if (sheetsData.length === 0) {
                showError('æ²¡æœ‰åæ ‡æ•°æ®ï¼Œè¯·å…ˆè¯†åˆ«æˆ–è¾“å…¥åæ ‡');
                return;
            }

            try {
                const response = await fetch('/generate_excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: filename,
                        tolerance: 0.03,
                        sheets_data: sheetsData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showError(error.error || 'Excelç”Ÿæˆå¤±è´¥');
                    return;
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.endsWith('.xlsx') ? filename : filename + '.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

            } catch (error) {
                showError('Excelä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        function clearAll() {
            document.getElementById('csv-output').value = '';
            document.getElementById('points-table-body').innerHTML = '';
            document.getElementById('result-section').classList.remove('show');
            document.getElementById('paste-csv-input').value = '';
            // é‡ç½®ç•Œé¢çŠ¶æ€
            document.getElementById('result-title').textContent = 'è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘ï¼‰';
            document.getElementById('generate-btn-section').style.display = 'block';
            // é‡ç½®æ•°æ®æ¨¡å¼é€‰æ‹©
            document.querySelector('input[name="data_mode"][value="ocr"]').checked = true;
            switchDataMode('ocr');
            clearImage();
            currentCSV = '';
            currentPoints = [];
            pastedFullData = null;
            currentInputMode = 'ocr';
            hideError();
        }

        function showError(message) {
            const alert = document.getElementById('error-alert');
            alert.textContent = 'âŒ ' + message;
            alert.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-alert').style.display = 'none';
        }
    </script>
</body>
</html>
